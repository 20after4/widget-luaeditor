# com-chilipeppr-widget-macro
This example widget gives you a framework for creating your own widget. Please change this description once you fork this template and create your own widget.

![alt text](screenshot.png "Screenshot")

## ChiliPeppr Widget / Template

All ChiliPeppr widgets/elements are defined using cpdefine() which is a method
that mimics require.js. Each defined object must have a unique ID so it does
not conflict with other ChiliPeppr widgets.

| Item                  | Value           |
| -------------         | ------------- | 
| ID                    | com-chilipeppr-widget-macro |
| Name                  | Widget / Template |
| Description           | This example widget gives you a framework for creating your own widget. Please change this description once you fork this template and create your own widget. |
| chilipeppr.load() URL | http://raw.githubusercontent.com/chilipeppr/com-chilipeppr-widget-macro/master/auto-generated-widget.html |
| Edit URL              | http://ide.c9.io/chilipeppr/com-chilipeppr-widget-macro |
| Github URL            | http://github.com/chilipeppr/com-chilipeppr-widget-macro |
| Test URL              | http://com-chilipeppr-widget-macro-chilipeppr.c9users.io/widget.html |

## Example Code for chilipeppr.load() Statement

You can use the code below as a starting point for instantiating this widget 
inside a workspace or from another widget. The key is that you need to load 
your widget inlined into a div so the DOM can parse your HTML, CSS, and 
Javascript. Then you use cprequire() to find your widget's Javascript and get 
back the instance of it.

```javascript
chilipeppr.load(
  "#myDivWidgetInsertedInto",
  "http://raw.githubusercontent.com/chilipeppr/com-chilipeppr-widget-macro/master/auto-generated-widget.html",
  function() {
    // Callback after widget loaded into #myDivWidgetInsertedInto
    cprequire(
      "inline:com-chilipeppr-widget-macro", // the id you gave your widget
      function(mywidget) {
        // Callback that is passed reference to your newly loaded widget
        console.log("My widget just got loaded.", mywidget);
        mywidget.init();
      }
    );
  }
);

```

## Publish

This widget/element publishes the following signals. These signals are owned by this widget/element and are published to all objects inside the ChiliPeppr environment that listen to them via the 
chilipeppr.subscribe(signal, callback) method. 
To better understand how ChiliPeppr's subscribe() method works see amplify.js's documentation at http://amplifyjs.com/api/pubsub/

| Signal | Description |
| ------ | ----------- |
| /com-chilipeppr-widget-macro/onExampleGenerate | Example: Publish this signal when we go to generate gcode. |

## Subscribe

This widget/element subscribes to the following signals. These signals are owned by this widget/element. Other objects inside the ChiliPeppr environment can publish to these signals via the chilipeppr.publish(signal, data) method. 
To better understand how ChiliPeppr's publish() method works see amplify.js's documentation at http://amplifyjs.com/api/pubsub/

| Signal | Description |
| ------ | ----------- |
| (No signals defined in this widget/element) |

## Foreign Publish

This widget/element publishes to the following signals that are owned by other objects. 
To better understand how ChiliPeppr's subscribe() method works see amplify.js's documentation at http://amplifyjs.com/api/pubsub/

| Signal | Description |
| ------ | ----------- |
| (No signals defined in this widget/element) |

## Foreign Subscribe

This widget/element publishes to the following signals that are owned by other objects.
To better understand how ChiliPeppr's publish() method works see amplify.js's documentation at http://amplifyjs.com/api/pubsub/

| Signal | Description |
| ------ | ----------- |
| (No signals defined in this widget/element) |

## Methods / Properties

The table below shows, in order, the methods and properties inside the widget/element.

| Item                  | Type          | Description |
| -------------         | ------------- | ----------- |
| id | string | "com-chilipeppr-widget-macro"<br><br>The ID of the widget. You must define this and make it unique. |
| name | string | "Widget / Template" |
| desc | string | "This example widget gives you a framework for creating your own widget. Please change this description once you fork this template and create your own widget." |
| url | string | "http://raw.githubusercontent.com/chilipeppr/com-chilipeppr-widget-macro/master/auto-generated-widget.html" |
| fiddleurl | string | "http://ide.c9.io/chilipeppr/com-chilipeppr-widget-macro" |
| githuburl | string | "http://github.com/chilipeppr/com-chilipeppr-widget-macro" |
| testurl | string | "http://com-chilipeppr-widget-macro-chilipeppr.c9users.io/widget.html" |
| publish | object | Please see docs above.<br><br>Define the publish signals that this widget/element owns or defines so thatother widgets know how to subscribe to them and what they do. |
| subscribe | object | Please see docs above.<br><br>Define the subscribe signals that this widget/element owns or defines so thatother widgets know how to subscribe to them and what they do. |
| foreignPublish | object | Please see docs above.<br><br>Document the foreign publish signals, i.e. signals owned by other widgetsor elements, that this widget/element publishes to. |
| foreignSubscribe | object | Please see docs above.<br><br>Document the foreign subscribe signals, i.e. signals owned by other widgetsor elements, that this widget/element subscribes to. |
| jscript | object |  |
| init | function | function ()  |
| setupStartup | function | function ()  |
| onStartup | function | function ()  |
| editStartup | function | function (evt)  |
| saveStartup | function | function (evt)  |
| makeTextareaAcceptTabs | function | function ()  |
| getJscript | function | function ()  |
| runMacro | function | function (macroStr, helpTxt)  |
| jscriptKeypress | function | function (evt)  |
| showData | function | function (datatxt)  |
| saveMacro | function | function ()  |
| deleteRecentFiles | function | function ()  |
| createRecentFileEntry | function | function (fileStr, info)  |
| buildRecentFileMenu | function | function ()  |
| loadFileFromLocalStorageKey | function | function (key)  |
| loadJscript | function | function (txt)  |
| setupSamples | function | function ()  |
| getMethodString | function | function (methodToGet)  |
| watchChiliPepprPauseSolderDispenser | function | function () <br><br>Document the foreign subscribe signals, i.e. signals owned by other widgetsor elements, that this widget/element subscribes to./foreignSubscribe: {// Define a key:value pair here as strings to document what signals you subscribe to// that are owned by foreign/other widgets.// '/com-chilipeppr-elem-dragdrop/ondropped': 'Example: We subscribe to this signal at a higher priority to intercept the signal. We do not let it propagate by returning false.'},jscript: null, // contains the javascript macro that the user is working withinit: function () {<br><br>this.forkSetup();<br><br>$('.com-chilipeppr-widget-macro-run').click(this.runMacro.bind(this));<br><br>// saveMacro$('.com-chilipeppr-widget-macro-save').click(this.saveMacro.bind(this));<br><br>// setup del files$('#com-chilipeppr-widget-macro .recent-file-delete').click( this.deleteRecentFiles.bind(this));<br><br>this.buildRecentFileMenu();<br><br>// make this object available in global namespacewindow['macro'] = this;console.log("made macro obj (this) available in global namepace so you can call macro.status(), etc:", macro);<br><br>// capture ctrl+enter on textarea$('.com-chilipeppr-widget-macro-jscript').keypress(this.jscriptKeypress.bind(this));<br><br>// samplesthis.setupSamples();<br><br>this.makeTextareaAcceptTabs();<br><br>// popovers$('#com-chilipeppr-widget-macro .panel-heading .btn').popover();<br><br>// see if startup scriptthis.setupStartup();<br><br>console.log(this.name + " done loading.");},setupStartup: function() {<br><br>// setup pulldown menu items$('.com-chilipeppr-widget-macro-startup-load').click(this.editStartup.bind(this));$('.com-chilipeppr-widget-macro-startup-save').click(this.saveStartup.bind(this));<br><br>// run startup scriptthis.onStartup();<br><br>},onStartup: function() {<br><br>// check if there's a startup script. if so, load and execute it// but only do it a bit later to give user time to hold shift key and// so other widgets are loadedvar that = this;setTimeout(function() {<br><br>// see if they want to bypassvar href = window.location.href;if (href && href.length > 0 && href.match(/nostartup=true/i)) {console.log("Bypassing startup script.");that.status("Bypassed startup script since ?nostartup=true in URL");<br><br>} else {var ss = localStorage.getItem('com-chilipeppr-widget-macro-startup');if (ss && ss.length > 0) {// there is a startup scriptconsole.log("There is a startup script. Run it.", ss);that.runMacro(ss, "startup");} else {console.log("No startup script to run.");that.status("No startup script to run.");}}<br><br>}, 5000);<br><br>// see if shift is currently pressed though and skip execution<br><br>},editStartup: function(evt) {console.log("editStartup. evt:", evt);<br><br>var script = localStorage.getItem('com-chilipeppr-widget-macro-startup');this.jscript = script;this.loadJscript(this.jscript);this.status("Loaded startup script");<br><br>},saveStartup: function(evt) {console.log("saveStartup. evt:", evt);var fileStr = this.getJscript();localStorage.setItem('com-chilipeppr-widget-macro-startup', fileStr);this.status("Saved startup script");},makeTextareaAcceptTabs: function() {$(document).delegate('.com-chilipeppr-widget-macro-jscript', 'keydown', function(e) {var keyCode = e.keyCode || e.which;<br><br>if (keyCode == 9) {e.preventDefault();var start = $(this).get(0).selectionStart;var end = $(this).get(0).selectionEnd;<br><br>// set textarea value to: text before caret + tab + text after caret$(this).val($(this).val().substring(0, start)+ "\t"+ $(this).val().substring(end));<br><br>// put caret at right position again$(this).get(0).selectionStart =$(this).get(0).selectionEnd = start + 1;}});},getJscript: function() {this.jscript = $('.com-chilipeppr-widget-macro-jscript').val();return this.jscript;},runMacro: function(macroStr, helpTxt) {<br><br>// allow a custom macro to be passed inif (typeof macroStr === "string") {this.jscript = macroStr;} else {this.getJscript();}<br><br>//this.jscript = $('.com-chilipeppr-widget-macro-jscript').val();<br><br>if (this.jscript && this.jscript.length > 1) {try {eval(this.jscript);<br><br>if (!helpTxt) helpTxt = "";helpTxt = helpTxt.trim();if (helpTxt.length > 0) helpTxt += " ";<br><br>this.status("Ran " + helpTxt + "macro. "); // + this.jscript);} catch(e) {//var etxt = JSON.stringify(e);console.log("Err running macro. err:", e);var etxt = e.message;var estack = null;if ('stack' in e) estack = e.stack;if (etxt != null && etxt.length > 0) {this.status("Error doing eval() on your script. Error: " + etxt );if (estack != null) this.status(estack);} else {this.status("Error doing eval() on your script.");}}} else {this.status("No script to run. Empty.");}},jscriptKeypress: function(evt) {//console.log("got keypress textarea. evt:", evt);if (evt.ctrlKey && evt.keyCode == 10) {// run the macro//$('.com-chilipeppr-widget-macro-run').click();this.runMacro();// mimic push on btn$('.com-chilipeppr-widget-macro-run').addClass('active');setTimeout(function() {$('.com-chilipeppr-widget-macro-run').removeClass('active');}, 200);}<br><br>},showData: function(datatxt) {$('#com-chilipeppr-widget-modal-macro-view .modal-body textarea').val(datatxt);//$('#com-chilipeppr-widget-modal-macro-view .modal-title').text("View Probe Data");$('#com-chilipeppr-widget-modal-macro-view').modal('show');},saveMacro: function() {<br><br>var fileStr = this.getJscript();var firstLine = "";if (fileStr.match(/(.*)\r{0,1}\n/)) {// we have our first linefirstLine = RegExp.$1;} else if (fileStr.length > 20) {firstLine = fileStr.substring(0,20);} else if (fileStr.length > 0) {firstLine = fileStr;}<br><br>var info = {name: "Macro " + firstLine,lastModified: new Date()};this.createRecentFileEntry(fileStr, info);this.status('Saved your file "' + info.name + '". Retrieve it from upper right pulldown.');<br><br>},deleteRecentFiles: function() {console.log("deleting files");// loop thru file storage and delete entries that match this widgetvar keysToDelete = [];for (var i = 0; i < localStorage.length; i++){console.log("localStorage.item.key:", localStorage.key(i));var key = localStorage.key(i);if (key.match(/com-chilipeppr-widget-macro-recent/)) {//localStorage.removeItem(key);keysToDelete.push(key);console.log("going to remove localstorage key:", key);}}keysToDelete.forEach(function(key) {localStorage.removeItem(key);});//localStorage.clear();this.buildRecentFileMenu();},createRecentFileEntry: function(fileStr, info) {console.log("createRecentFileEntry. fileStr.length:", fileStr.length, "info:", info);// get the next avail slotvar lastSlot = -1;for(var ctr = 0; ctr < 100; ctr++) {if ('com-chilipeppr-widget-macro-recent' + ctr in localStorage) {console.log("found recent file entry. ctr:", ctr);lastSlot = ctr;}}console.log("lastSlot we found:", lastSlot);<br><br>var nextSlot = lastSlot + 1;var recent = localStorage.getItem("com-chilipeppr-widget-macro-recent" + nextSlot);if (recent == null) {console.log("empty slot. filling.");localStorage.setItem("com-chilipeppr-widget-macro-recent" + nextSlot, fileStr);localStorage.setItem("com-chilipeppr-widget-macro-recent" + nextSlot + "-name", info.name);localStorage.setItem("com-chilipeppr-widget-macro-recent" + nextSlot + "-lastMod", info.lastModified);this.buildRecentFileMenu();}<br><br>},buildRecentFileMenu: function() {<br><br>// cleanup prev recent files$('#com-chilipeppr-widget-macro .dropdown-menu-main > li.recent-file-item').remove();<br><br>var li = $('#com-chilipeppr-widget-macro .dropdown-menu-main > li.recent-files');console.log("listItems:", li);<br><br>// get all macro filesvar keysForMacros = [];for (var i = 0; i < localStorage.length; i++){console.log("localStorage.item.key:", localStorage.key(i));var key = localStorage.key(i);if (key.match(/com-chilipeppr-widget-macro-recent(\d+)-name/)) {//localStorage.removeItem(key);var keyCtr = RegExp.$1;keysForMacros.push(keyCtr);console.log("found a macro name with localstorage key:", key, "keyCtr:", keyCtr);}}keysForMacros.forEach(function(key) {localStorage.removeItem(key);});<br><br>//var ctr = 0;for(var i = 0; i < keysForMacros.length; i++) {var ctr = keysForMacros[i];var recentName = localStorage.getItem("com-chilipeppr-widget-macro-recent" + ctr + "-name");//while(recentName != null) {console.log("recentFile ctr:", ctr, "recentName:", recentName);var recentLastModified = localStorage.getItem("com-chilipeppr-widget-macro-recent" + ctr + "-lastMod");var rlm = new Date(recentLastModified);var recentSize = localStorage.getItem("com-chilipeppr-widget-macro-recent" + ctr).length;var rsize = parseInt(recentSize / 1024);if (rsize == 0) rsize = 1;var newLi = $('<li class="recent-file-item"><a href="javascript:">' + recentName +' <span class="lastModifyDate">' + rlm.toLocaleString() + '</span>' +' ' + rsize + 'KB' +'</a></li>');//' <button type="button" class="btn btn-default btn-xs"><span class="glyphicon glyphicon-trash"></span></button></a></li>');newLi.insertAfter(li);var that = this;newLi.click("com-chilipeppr-widget-macro-recent" + ctr, function(data) {console.log("got recent file click. data:", data);var key = data.data;that.loadFileFromLocalStorageKey(key);<br><br>});<br><br>//ctr++;//recentName = localStorage.getItem("com-chilipeppr-widget-macro-recent" + ctr + "-name");<br><br>}},loadFileFromLocalStorageKey: function(key) {// load file into probesvar info = {name: localStorage.getItem(key + '-name'), lastModified: localStorage.getItem(key + '-lastMod')};console.log("loading macro data. localStorage.key:", key, "info:", info);<br><br>// load the datathis.jscript = localStorage.getItem(key);this.loadJscript(this.jscript);this.status("Loaded data \"" + info.name + "\"");},loadJscript: function(txt) {//this.jscript = txt;$('.com-chilipeppr-widget-macro-jscript').val(txt);console.log("loaded jscript");},setupSamples: function() {var that = this;$('.com-chilipeppr-widget-macro-sample.sample-alert').click(function() { that.loadJscript('alert("Ahhh. Something went wrong!");');});$('.com-chilipeppr-widget-macro-sample.sample-status').click(function() { that.loadJscript('macro.status("I just put a status item entry in.");');});$('.com-chilipeppr-widget-macro-sample.sample-send').click(function() { that.loadJscript('macro.sendSerial("?\\n");');});$('.com-chilipeppr-widget-macro-sample.sample-sendpub').click(function() { that.loadJscript('// Uses the official pubsub method\n' +'// to send to serial port when serial\n' + '// port widget is in single select mode\n' + 'chilipeppr.publish("/com-chilipeppr-widget-serialport/send", "G1 X10 F500\\n");');});<br><br>$('.com-chilipeppr-widget-macro-sample.sample-sendgcode').click(function() { that.loadJscript('macro.sendSerial("G0 X0 Y0\\n");');});<br><br>$('.com-chilipeppr-widget-macro-sample.sample-sendaltport').click(function() { var txt = that.getMethodString(that.sendToArduino);that.loadJscript(txt);});<br><br>$('.com-chilipeppr-widget-macro-sample.sample-watch').click(function() { //var txt = that.watch.toString();var txt = that.getMethodString(that.watch);//console.log("watch jscript:", txt, "that.watch:", that.watch);that.loadJscript(txt);});<br><br>$('.com-chilipeppr-widget-macro-sample.sample-loadgcode').click(function() { //var txt = that.watch.toString();var txt = that.getMethodString(that.sendGcodeToWorkspace);//console.log("watch jscript:", txt, "that.watch:", that.watch);that.loadJscript(txt);});<br><br>$('.com-chilipeppr-widget-macro-sample.sample-fadeout').click(function() { var txt = that.getMethodString(that.fadeout);that.loadJscript(txt);});<br><br>//bbox$('.com-chilipeppr-widget-macro-sample.sample-bbox').click(function() { var txt = that.getMethodString(that.addbbox);that.loadJscript(txt);});<br><br>// list of gcode cmds$('.com-chilipeppr-widget-macro-sample.sample-loopcmds').click(function() { var txt = that.getMethodString(that.cmdsSentViaTimeout);that.loadJscript(txt);});<br><br>// downloadgcode$('.com-chilipeppr-widget-macro-sample.sample-downloadgcode').click(function() { var txt = that.getMethodString(that.downloadGcode);that.loadJscript(txt);});<br><br>// injectCams$('.com-chilipeppr-widget-macro-sample.sample-injectCams').click(function() { var txt = that.getMethodString(that.injectCams);that.loadJscript(txt);});<br><br>// iterateGcode$('.com-chilipeppr-widget-macro-sample.sample-iterateGcode').click(function() { var txt = that.getMethodString(that.iterateGcode);that.loadJscript(txt);});<br><br>// watchOnComplete$('.com-chilipeppr-widget-macro-sample.sample-watchOnComplete').click(function() { var txt = that.getMethodString(that.watchOnCompleteControlArduino);that.loadJscript(txt);});<br><br>// rewriteGcode$('.com-chilipeppr-widget-macro-sample.sample-rewritegcode').click(function() { var txt = that.getMethodString(that.rewriteGcode);that.loadJscript(txt);});<br><br>// injectBtn$('.com-chilipeppr-widget-macro-sample.sample-injectbtn').click(function() { var txt = that.getMethodString(that.injectBtn);that.loadJscript(txt);});<br><br>// get3dobj$('.com-chilipeppr-widget-macro-sample.sample-get3dobj').click(function() { var txt = that.getMethodString(that.get3dobj);that.loadJscript(txt);});<br><br>// get3dobjG1FromG2G3$('.com-chilipeppr-widget-macro-sample.sample-get3dobjG1FromG2G3').click(function() { var txt = that.getMethodString(that.get3dobjG1FromG2G3);that.loadJscript(txt);});<br><br>// flashMsg$('.com-chilipeppr-widget-macro-sample.sample-flashMsg').click(function() { var txt = that.getMethodString(that.flashMsg);that.loadJscript(txt);});<br><br>// watchChiliPepprPause$('.com-chilipeppr-widget-macro-sample.sample-watchChiliPepprPause').click(function() { var txt = that.getMethodString(that.watchChiliPepprPause);that.loadJscript(txt);});<br><br>// watchChiliPepprPauseSolderDispenser$('.com-chilipeppr-widget-macro-sample.sample-watchChiliPepprPauseSolderDispenser').click(function() { var txt = that.getMethodString(that.watchChiliPepprPauseSolderDispenser);that.loadJscript(txt);});<br><br>},getMethodString: function(methodToGet) {var txt = methodToGet.toString();// remove first and last linesvar arr = txt.split("\n");var ctr = 0;arr.forEach(function(item) {arr[ctr] = item.replace(/            /, "");arr[ctr] = arr[ctr].replace(/    /g, "\t");ctr++;});arr = arr.splice(1, arr.length - 2);return arr.join("\n");},<br><br>/* START SAMPLES |
| watchChiliPepprPause | function | function ()  |
| flashMsg | function | function ()  |
| get3dobj | function | function ()  |
| get3dobjG1FromG2G3 | function | function ()  |
| injectBtn | function | function ()  |
| rewriteGcode | function | function ()  |
| watchOnCompleteControlArduino | function | function ()  |
| iterateGcode | function | function ()  |
| injectCams | function | function ()  |
| downloadGcode | function | function ()  |
| sendToArduino | function | function ()  |
| cmdsSentViaTimeout | function | function ()  |
| addbbox | function | function ()  |
| fadeout | function | function ()  |
| sendGcodeToWorkspace | function | function ()  |
| runTestProbe | function | function ()  |
| watch | function | function ()  |
| sendSerial | function | function (gcode)  |
| statEl | object | Document the foreign subscribe signals, i.e. signals owned by other widgetsor elements, that this widget/element subscribes to./foreignSubscribe: {// Define a key:value pair here as strings to document what signals you subscribe to// that are owned by foreign/other widgets.// '/com-chilipeppr-elem-dragdrop/ondropped': 'Example: We subscribe to this signal at a higher priority to intercept the signal. We do not let it propagate by returning false.'},jscript: null, // contains the javascript macro that the user is working withinit: function () {<br><br>this.forkSetup();<br><br>$('.com-chilipeppr-widget-macro-run').click(this.runMacro.bind(this));<br><br>// saveMacro$('.com-chilipeppr-widget-macro-save').click(this.saveMacro.bind(this));<br><br>// setup del files$('#com-chilipeppr-widget-macro .recent-file-delete').click( this.deleteRecentFiles.bind(this));<br><br>this.buildRecentFileMenu();<br><br>// make this object available in global namespacewindow['macro'] = this;console.log("made macro obj (this) available in global namepace so you can call macro.status(), etc:", macro);<br><br>// capture ctrl+enter on textarea$('.com-chilipeppr-widget-macro-jscript').keypress(this.jscriptKeypress.bind(this));<br><br>// samplesthis.setupSamples();<br><br>this.makeTextareaAcceptTabs();<br><br>// popovers$('#com-chilipeppr-widget-macro .panel-heading .btn').popover();<br><br>// see if startup scriptthis.setupStartup();<br><br>console.log(this.name + " done loading.");},setupStartup: function() {<br><br>// setup pulldown menu items$('.com-chilipeppr-widget-macro-startup-load').click(this.editStartup.bind(this));$('.com-chilipeppr-widget-macro-startup-save').click(this.saveStartup.bind(this));<br><br>// run startup scriptthis.onStartup();<br><br>},onStartup: function() {<br><br>// check if there's a startup script. if so, load and execute it// but only do it a bit later to give user time to hold shift key and// so other widgets are loadedvar that = this;setTimeout(function() {<br><br>// see if they want to bypassvar href = window.location.href;if (href && href.length > 0 && href.match(/nostartup=true/i)) {console.log("Bypassing startup script.");that.status("Bypassed startup script since ?nostartup=true in URL");<br><br>} else {var ss = localStorage.getItem('com-chilipeppr-widget-macro-startup');if (ss && ss.length > 0) {// there is a startup scriptconsole.log("There is a startup script. Run it.", ss);that.runMacro(ss, "startup");} else {console.log("No startup script to run.");that.status("No startup script to run.");}}<br><br>}, 5000);<br><br>// see if shift is currently pressed though and skip execution<br><br>},editStartup: function(evt) {console.log("editStartup. evt:", evt);<br><br>var script = localStorage.getItem('com-chilipeppr-widget-macro-startup');this.jscript = script;this.loadJscript(this.jscript);this.status("Loaded startup script");<br><br>},saveStartup: function(evt) {console.log("saveStartup. evt:", evt);var fileStr = this.getJscript();localStorage.setItem('com-chilipeppr-widget-macro-startup', fileStr);this.status("Saved startup script");},makeTextareaAcceptTabs: function() {$(document).delegate('.com-chilipeppr-widget-macro-jscript', 'keydown', function(e) {var keyCode = e.keyCode || e.which;<br><br>if (keyCode == 9) {e.preventDefault();var start = $(this).get(0).selectionStart;var end = $(this).get(0).selectionEnd;<br><br>// set textarea value to: text before caret + tab + text after caret$(this).val($(this).val().substring(0, start)+ "\t"+ $(this).val().substring(end));<br><br>// put caret at right position again$(this).get(0).selectionStart =$(this).get(0).selectionEnd = start + 1;}});},getJscript: function() {this.jscript = $('.com-chilipeppr-widget-macro-jscript').val();return this.jscript;},runMacro: function(macroStr, helpTxt) {<br><br>// allow a custom macro to be passed inif (typeof macroStr === "string") {this.jscript = macroStr;} else {this.getJscript();}<br><br>//this.jscript = $('.com-chilipeppr-widget-macro-jscript').val();<br><br>if (this.jscript && this.jscript.length > 1) {try {eval(this.jscript);<br><br>if (!helpTxt) helpTxt = "";helpTxt = helpTxt.trim();if (helpTxt.length > 0) helpTxt += " ";<br><br>this.status("Ran " + helpTxt + "macro. "); // + this.jscript);} catch(e) {//var etxt = JSON.stringify(e);console.log("Err running macro. err:", e);var etxt = e.message;var estack = null;if ('stack' in e) estack = e.stack;if (etxt != null && etxt.length > 0) {this.status("Error doing eval() on your script. Error: " + etxt );if (estack != null) this.status(estack);} else {this.status("Error doing eval() on your script.");}}} else {this.status("No script to run. Empty.");}},jscriptKeypress: function(evt) {//console.log("got keypress textarea. evt:", evt);if (evt.ctrlKey && evt.keyCode == 10) {// run the macro//$('.com-chilipeppr-widget-macro-run').click();this.runMacro();// mimic push on btn$('.com-chilipeppr-widget-macro-run').addClass('active');setTimeout(function() {$('.com-chilipeppr-widget-macro-run').removeClass('active');}, 200);}<br><br>},showData: function(datatxt) {$('#com-chilipeppr-widget-modal-macro-view .modal-body textarea').val(datatxt);//$('#com-chilipeppr-widget-modal-macro-view .modal-title').text("View Probe Data");$('#com-chilipeppr-widget-modal-macro-view').modal('show');},saveMacro: function() {<br><br>var fileStr = this.getJscript();var firstLine = "";if (fileStr.match(/(.*)\r{0,1}\n/)) {// we have our first linefirstLine = RegExp.$1;} else if (fileStr.length > 20) {firstLine = fileStr.substring(0,20);} else if (fileStr.length > 0) {firstLine = fileStr;}<br><br>var info = {name: "Macro " + firstLine,lastModified: new Date()};this.createRecentFileEntry(fileStr, info);this.status('Saved your file "' + info.name + '". Retrieve it from upper right pulldown.');<br><br>},deleteRecentFiles: function() {console.log("deleting files");// loop thru file storage and delete entries that match this widgetvar keysToDelete = [];for (var i = 0; i < localStorage.length; i++){console.log("localStorage.item.key:", localStorage.key(i));var key = localStorage.key(i);if (key.match(/com-chilipeppr-widget-macro-recent/)) {//localStorage.removeItem(key);keysToDelete.push(key);console.log("going to remove localstorage key:", key);}}keysToDelete.forEach(function(key) {localStorage.removeItem(key);});//localStorage.clear();this.buildRecentFileMenu();},createRecentFileEntry: function(fileStr, info) {console.log("createRecentFileEntry. fileStr.length:", fileStr.length, "info:", info);// get the next avail slotvar lastSlot = -1;for(var ctr = 0; ctr < 100; ctr++) {if ('com-chilipeppr-widget-macro-recent' + ctr in localStorage) {console.log("found recent file entry. ctr:", ctr);lastSlot = ctr;}}console.log("lastSlot we found:", lastSlot);<br><br>var nextSlot = lastSlot + 1;var recent = localStorage.getItem("com-chilipeppr-widget-macro-recent" + nextSlot);if (recent == null) {console.log("empty slot. filling.");localStorage.setItem("com-chilipeppr-widget-macro-recent" + nextSlot, fileStr);localStorage.setItem("com-chilipeppr-widget-macro-recent" + nextSlot + "-name", info.name);localStorage.setItem("com-chilipeppr-widget-macro-recent" + nextSlot + "-lastMod", info.lastModified);this.buildRecentFileMenu();}<br><br>},buildRecentFileMenu: function() {<br><br>// cleanup prev recent files$('#com-chilipeppr-widget-macro .dropdown-menu-main > li.recent-file-item').remove();<br><br>var li = $('#com-chilipeppr-widget-macro .dropdown-menu-main > li.recent-files');console.log("listItems:", li);<br><br>// get all macro filesvar keysForMacros = [];for (var i = 0; i < localStorage.length; i++){console.log("localStorage.item.key:", localStorage.key(i));var key = localStorage.key(i);if (key.match(/com-chilipeppr-widget-macro-recent(\d+)-name/)) {//localStorage.removeItem(key);var keyCtr = RegExp.$1;keysForMacros.push(keyCtr);console.log("found a macro name with localstorage key:", key, "keyCtr:", keyCtr);}}keysForMacros.forEach(function(key) {localStorage.removeItem(key);});<br><br>//var ctr = 0;for(var i = 0; i < keysForMacros.length; i++) {var ctr = keysForMacros[i];var recentName = localStorage.getItem("com-chilipeppr-widget-macro-recent" + ctr + "-name");//while(recentName != null) {console.log("recentFile ctr:", ctr, "recentName:", recentName);var recentLastModified = localStorage.getItem("com-chilipeppr-widget-macro-recent" + ctr + "-lastMod");var rlm = new Date(recentLastModified);var recentSize = localStorage.getItem("com-chilipeppr-widget-macro-recent" + ctr).length;var rsize = parseInt(recentSize / 1024);if (rsize == 0) rsize = 1;var newLi = $('<li class="recent-file-item"><a href="javascript:">' + recentName +' <span class="lastModifyDate">' + rlm.toLocaleString() + '</span>' +' ' + rsize + 'KB' +'</a></li>');//' <button type="button" class="btn btn-default btn-xs"><span class="glyphicon glyphicon-trash"></span></button></a></li>');newLi.insertAfter(li);var that = this;newLi.click("com-chilipeppr-widget-macro-recent" + ctr, function(data) {console.log("got recent file click. data:", data);var key = data.data;that.loadFileFromLocalStorageKey(key);<br><br>});<br><br>//ctr++;//recentName = localStorage.getItem("com-chilipeppr-widget-macro-recent" + ctr + "-name");<br><br>}},loadFileFromLocalStorageKey: function(key) {// load file into probesvar info = {name: localStorage.getItem(key + '-name'), lastModified: localStorage.getItem(key + '-lastMod')};console.log("loading macro data. localStorage.key:", key, "info:", info);<br><br>// load the datathis.jscript = localStorage.getItem(key);this.loadJscript(this.jscript);this.status("Loaded data \"" + info.name + "\"");},loadJscript: function(txt) {//this.jscript = txt;$('.com-chilipeppr-widget-macro-jscript').val(txt);console.log("loaded jscript");},setupSamples: function() {var that = this;$('.com-chilipeppr-widget-macro-sample.sample-alert').click(function() { that.loadJscript('alert("Ahhh. Something went wrong!");');});$('.com-chilipeppr-widget-macro-sample.sample-status').click(function() { that.loadJscript('macro.status("I just put a status item entry in.");');});$('.com-chilipeppr-widget-macro-sample.sample-send').click(function() { that.loadJscript('macro.sendSerial("?\\n");');});$('.com-chilipeppr-widget-macro-sample.sample-sendpub').click(function() { that.loadJscript('// Uses the official pubsub method\n' +'// to send to serial port when serial\n' + '// port widget is in single select mode\n' + 'chilipeppr.publish("/com-chilipeppr-widget-serialport/send", "G1 X10 F500\\n");');});<br><br>$('.com-chilipeppr-widget-macro-sample.sample-sendgcode').click(function() { that.loadJscript('macro.sendSerial("G0 X0 Y0\\n");');});<br><br>$('.com-chilipeppr-widget-macro-sample.sample-sendaltport').click(function() { var txt = that.getMethodString(that.sendToArduino);that.loadJscript(txt);});<br><br>$('.com-chilipeppr-widget-macro-sample.sample-watch').click(function() { //var txt = that.watch.toString();var txt = that.getMethodString(that.watch);//console.log("watch jscript:", txt, "that.watch:", that.watch);that.loadJscript(txt);});<br><br>$('.com-chilipeppr-widget-macro-sample.sample-loadgcode').click(function() { //var txt = that.watch.toString();var txt = that.getMethodString(that.sendGcodeToWorkspace);//console.log("watch jscript:", txt, "that.watch:", that.watch);that.loadJscript(txt);});<br><br>$('.com-chilipeppr-widget-macro-sample.sample-fadeout').click(function() { var txt = that.getMethodString(that.fadeout);that.loadJscript(txt);});<br><br>//bbox$('.com-chilipeppr-widget-macro-sample.sample-bbox').click(function() { var txt = that.getMethodString(that.addbbox);that.loadJscript(txt);});<br><br>// list of gcode cmds$('.com-chilipeppr-widget-macro-sample.sample-loopcmds').click(function() { var txt = that.getMethodString(that.cmdsSentViaTimeout);that.loadJscript(txt);});<br><br>// downloadgcode$('.com-chilipeppr-widget-macro-sample.sample-downloadgcode').click(function() { var txt = that.getMethodString(that.downloadGcode);that.loadJscript(txt);});<br><br>// injectCams$('.com-chilipeppr-widget-macro-sample.sample-injectCams').click(function() { var txt = that.getMethodString(that.injectCams);that.loadJscript(txt);});<br><br>// iterateGcode$('.com-chilipeppr-widget-macro-sample.sample-iterateGcode').click(function() { var txt = that.getMethodString(that.iterateGcode);that.loadJscript(txt);});<br><br>// watchOnComplete$('.com-chilipeppr-widget-macro-sample.sample-watchOnComplete').click(function() { var txt = that.getMethodString(that.watchOnCompleteControlArduino);that.loadJscript(txt);});<br><br>// rewriteGcode$('.com-chilipeppr-widget-macro-sample.sample-rewritegcode').click(function() { var txt = that.getMethodString(that.rewriteGcode);that.loadJscript(txt);});<br><br>// injectBtn$('.com-chilipeppr-widget-macro-sample.sample-injectbtn').click(function() { var txt = that.getMethodString(that.injectBtn);that.loadJscript(txt);});<br><br>// get3dobj$('.com-chilipeppr-widget-macro-sample.sample-get3dobj').click(function() { var txt = that.getMethodString(that.get3dobj);that.loadJscript(txt);});<br><br>// get3dobjG1FromG2G3$('.com-chilipeppr-widget-macro-sample.sample-get3dobjG1FromG2G3').click(function() { var txt = that.getMethodString(that.get3dobjG1FromG2G3);that.loadJscript(txt);});<br><br>// flashMsg$('.com-chilipeppr-widget-macro-sample.sample-flashMsg').click(function() { var txt = that.getMethodString(that.flashMsg);that.loadJscript(txt);});<br><br>// watchChiliPepprPause$('.com-chilipeppr-widget-macro-sample.sample-watchChiliPepprPause').click(function() { var txt = that.getMethodString(that.watchChiliPepprPause);that.loadJscript(txt);});<br><br>// watchChiliPepprPauseSolderDispenser$('.com-chilipeppr-widget-macro-sample.sample-watchChiliPepprPauseSolderDispenser').click(function() { var txt = that.getMethodString(that.watchChiliPepprPauseSolderDispenser);that.loadJscript(txt);});<br><br>},getMethodString: function(methodToGet) {var txt = methodToGet.toString();// remove first and last linesvar arr = txt.split("\n");var ctr = 0;arr.forEach(function(item) {arr[ctr] = item.replace(/            /, "");arr[ctr] = arr[ctr].replace(/    /g, "\t");ctr++;});arr = arr.splice(1, arr.length - 2);return arr.join("\n");},<br><br>/* START SAMPLES */watchChiliPepprPauseSolderDispenser: function() {// This macro shows how to watch for the chilipeppr// pause sync event that is triggered if you include// a comment in your gcode file like // (chilipeppr_pause) or ; chilipeppr_pause// And then it sends commands to a 2nd CNC controller// to actually dispense solder paste//// Here is a sample gcode file that uses chilipeppr_pause/*G0 X0 Y0 Z0F50G1 X10(chilipeppr_pause trigger laser on)G1 X20(chilipeppr_pause trigger laser off)G0 X0/var myWatchChiliPepprPause = {serialPort: "/dev/ttyUSB0",init: function() {// Uninit previous runs to unsubscribe correctly, i.e.// so we don't subscribe 100's of times each time we modify// and run this macroif (window["myWatchChiliPepprPause"]) {macro.status("This macro was run before. Cleaning up...");window["myWatchChiliPepprPause"].uninit();}macro.status("Subscribing to chilipeppr_pause pubsub event");<br><br>// store macro in window object so we have it next time thruwindow["myWatchChiliPepprPause"] = this;<br><br>this.setupSubscribe();<br><br>//this.openPort();<br><br>chilipeppr.publish("/com-chilipeppr-elem-flashmsg/flashmsg", "Initting Example of Solder Paste Dispenser", "Shows how to use chilipeppr_pause Gcode command and 2nd CNC controller");},uninit: function() {macro.status("Uninitting chilipeppr_pause macro.");this.unsetupSubscribe();},setupSubscribe: function() {// Subscribe to both events because you will not// get onComplete if the controller is sophisticated// enough to send onExecute, i.e. TinyG will only// get onExecute events while Grbl will only get// onComplete eventschilipeppr.subscribe("/com-chilipeppr-widget-gcode/onChiliPepprPauseOnExecute", this, this.onChiliPepprPauseOnExecute);chilipeppr.subscribe("/com-chilipeppr-widget-gcode/onChiliPepprPauseOnComplete", this, this.onChiliPepprPauseOnComplete);},unsetupSubscribe: function() {chilipeppr.unsubscribe("/com-chilipeppr-widget-gcode/onChiliPepprPauseOnExecute", this.onChiliPepprPauseOnExecute);chilipeppr.unsubscribe("/com-chilipeppr-widget-gcode/onChiliPepprPauseOnComplete", this.onChiliPepprPauseOnComplete);},onChiliPepprPauseOnExecute: function(data) {macro.status("Got onChiliPepprPauseOnExecute. Will unpause in 10 seconds.");console.log("got onChiliPepprPauseOnExecute. data:", data);//chilipeppr.publish("/com-chilipeppr-elem-flashmsg/flashmsg", "Time to sync", "Pretend we are sending a command to our solder paste dispenser to do its thing and then we will unpause our main Gcode file.", 4000);<br><br>this.dispense();setTimeout(this.unpauseGcode, 1000);},onChiliPepprPauseOnComplete: function(data) {macro.status("Got onChiliPepprPauseOnComplete. Will unpause in 10 seconds.");console.log("got onChiliPepprPauseOnComplete. data:", data);//chilipeppr.publish("/com-chilipeppr-elem-flashmsg/flashmsg", "Time to sync", "Pretend we are sending a command to our solder paste dispenser to do its thing and then we will unpause our main Gcode file.", 14000);<br><br>setTimeout(this.dispense.bind(this), 3000);<br><br>// since we'll get this onComplete way ahead of moves,// wait WAYYY longer than onExecutesetTimeout(this.unpauseGcode, 5000);},unpauseGcode: function() {macro.status("Just unpaused gcode.");chilipeppr.publish("/com-chilipeppr-widget-gcode/pause", "");},ctr: 0,dispense: function() {<br><br>this.ctr++;macro.status("Dispensing drop " + this.ctr);var cmd = "sendjson "; // + this.serialPort + " ";var payload = {P: this.serialPort,Data: [{D: "G91\n",Id: "dispenseRelCoords" + this.ctr},{D: "G1 F200 X1.5\n",Id: "dispense" + this.ctr}<br><br>]};cmd += JSON.stringify(payload) + "\n";chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", cmd);<br><br>},openPort: function() {<br><br>chilipeppr.publish("/com-chilipeppr-elem-flashmsg/flashmsg", "Opening serial port", "We are ensuring the port " + this.serialPort + " is open so we can write to it.", 3000);<br><br>var cmd = "open " + this.serialPort + " 115200 tinyg";cmd += "\n";chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", cmd);<br><br>}}myWatchChiliPepprPause.init();},watchChiliPepprPause: function() {// This macro shows how to watch for the chilipeppr// pause sync event that is triggered if you include// a comment in your gcode file like // (chilipeppr_pause) or ; chilipeppr_pause//// Here is a sample gcode file that uses chilipeppr_pause/*G0 X0 Y0 Z0F50G1 X10(chilipeppr_pause trigger laser on)G1 X20(chilipeppr_pause trigger laser off)G0 X0/var myWatchChiliPepprPause = {init: function() {// Uninit previous runs to unsubscribe correctly, i.e.// so we don't subscribe 100's of times each time we modify// and run this macroif (window["myWatchChiliPepprPause"]) {macro.status("This macro was run before. Cleaning up...");window["myWatchChiliPepprPause"].uninit();}macro.status("Subscribing to chilipeppr_pause pubsub event");<br><br>// store macro in window object so we have it next time thruwindow["myWatchChiliPepprPause"] = this;<br><br>this.setupSubscribe();},uninit: function() {macro.status("Uninitting chilipeppr_pause macro.");this.unsetupSubscribe();},setupSubscribe: function() {// Subscribe to both events because you will not// get onComplete if the controller is sophisticated// enough to send onExecute, i.e. TinyG will only// get onExecute events while Grbl will only get// onComplete eventschilipeppr.subscribe("/com-chilipeppr-widget-gcode/onChiliPepprPauseOnExecute", this, this.onChiliPepprPauseOnExecute);chilipeppr.subscribe("/com-chilipeppr-widget-gcode/onChiliPepprPauseOnComplete", this, this.onChiliPepprPauseOnComplete);},unsetupSubscribe: function() {chilipeppr.unsubscribe("/com-chilipeppr-widget-gcode/onChiliPepprPauseOnExecute", this.onChiliPepprPauseOnExecute);chilipeppr.unsubscribe("/com-chilipeppr-widget-gcode/onChiliPepprPauseOnComplete", this.onChiliPepprPauseOnComplete);},onChiliPepprPauseOnExecute: function(data) {macro.status("Got onChiliPepprPauseOnExecute. Will unpause in 10 seconds.");console.log("got onChiliPepprPauseOnExecute. data:", data);chilipeppr.publish("/com-chilipeppr-elem-flashmsg/flashmsg", "Time to sync", "Pretend we are sending a command to our solder paste dispenser to do its thing and then we will unpause our main Gcode file.", 9000);setTimeout(this.unpauseGcode, 10000);},onChiliPepprPauseOnComplete: function(data) {macro.status("Got onChiliPepprPauseOnComplete. Will unpause in 10 seconds.");console.log("got onChiliPepprPauseOnComplete. data:", data);chilipeppr.publish("/com-chilipeppr-elem-flashmsg/flashmsg", "Time to sync", "Pretend we are sending a command to our solder paste dispenser to do its thing and then we will unpause our main Gcode file.", 9000);setTimeout(this.unpauseGcode, 10000);},unpauseGcode: function() {macro.status("Just unpaused gcode.");chilipeppr.publish("/com-chilipeppr-widget-gcode/pause", "");}}myWatchChiliPepprPause.init();},flashMsg: function() {chilipeppr.publish("/com-chilipeppr-elem-flashmsg/flashmsg", "My title", "My body");chilipeppr.publish("/com-chilipeppr-elem-flashmsg/flashmsg", "My title", "Only show for 1 second", 1000);},get3dobj: function() {var get3dObj= function() {chilipeppr.subscribe("/com-chilipeppr-widget-3dviewer/recv3dObject", recv3dObj);chilipeppr.publish("/com-chilipeppr-widget-3dviewer/request3dObject", "");chilipeppr.unsubscribe("/com-chilipeppr-widget-3dviewer/recv3dObject", recv3dObj);};<br><br>var recv3dObj = function(obj) {console.log("got 3d obj:", obj);macro.status("got 3d obj");}<br><br>get3dObj();<br><br>},get3dobjG1FromG2G3: function() {var get3dObj= function() {chilipeppr.subscribe("/com-chilipeppr-widget-3dviewer/recv3dObject", recv3dObj);chilipeppr.publish("/com-chilipeppr-widget-3dviewer/request3dObject", "");chilipeppr.unsubscribe("/com-chilipeppr-widget-3dviewer/recv3dObject", recv3dObj);};<br><br>var recv3dObj = function(obj) {console.log("got 3d obj:", obj);// Get Gcode lines from 3dObjvar gcodelines = obj.userData.lines;// Loop thru lines to see if there are G2 or G3'sfor (var i = 0; i < gcodelines .length; i++) {var line = gcodelines[i];if (line.p2 && line.p2.arc) {console.log("the G1 version of the G2/G3 arc for gcode line:", i, line.p2.threeObjArc.geometry.vertices);}}macro.status("got 3d obj");}<br><br>get3dObj();},injectBtn: function() {// This macro shows how to inject a button into the macro// toolbar for use inside your macro.var myMacroBtns = {init: function() {// Uninit previous runs to unsubscribe correctly, i.e.// so we don't subscribe 100's of times each time we modify// and run this macroif (window["myMacroBtns"]) {macro.status("This macro was run before. Cleaning up...");window["myMacroBtns"].uninit();}macro.status("Adding buttons to macro toolbar");<br><br>// store macro in window object so we have it next time thruwindow["myMacroBtns"] = this;<br><br>this.addBtns();},uninit: function() {macro.status("Uninitting macro.");this.removeBtns();},addBtns: function() {var btnGrp = $('<div class="btn-group pull-right mymacrobtns" style="margin-right:6px;"></div>');var btn1 = $('<button type="button" class="btn btn-xs btn-default mymacro-btn1">1</button>');btn1.click(this.onBtn1Click.bind(this));var btn2 = $('<button type="button" class="btn btn-xs btn-default mymacro-btn2">2</button>');btn2.click(this.onBtn2Click.bind(this));btnGrp.append(btn1);btnGrp.append(btn2);$('#com-chilipeppr-widget-macro .panel-heading').append(btnGrp);},removeBtns: function() {$('#com-chilipeppr-widget-macro .panel-heading .mymacrobtns').remove();},onBtn1Click: function(evt) {macro.status("Button 1 clicked.");},onBtn2Click: function(evt) {macro.status("Button 2 clicked.");}}myMacroBtns.init();},rewriteGcode: function() {// Rewrite g-code on-the-fly to 4-axis pulley system as it's// sent to the CNC controller. This means the XYZ values are// translated from their coordinates on each line of Gcode via// the pythagorean formula to pulley string lengths.//// This macro shows how to intercept the gcode as it's sent,// cancel the send, rewrite it to new gcode, and then resend.// The intercepting capabilities are due to the loosely coupled// design of ChiliPeppr where all widget interaction is done via// pubsub, thus giving you control to intercept or listen in on// the signals.//// This macro also shows how to use the 3D viewer XYZ values// translated from the original Gcode to know an exact XYZ// value for each line of Gcode.<br><br>var myMacro = {init: function() {// Uninit previous runs to unsubscribe correctly, i.e.// so we don't subscribe 100's of times each time we modify// and run this macroif (window["myMacro"]) {macro.status("This macro was run before. Cleaning up...");window["myMacro"].uninit();}macro.status("Starting watch on pulley rewrite macro");// subscribe to JSON send at a higher priority than the default// so we can intercept these pubsub's before they go to the TinyG// cuz we're going to rewrite them// The 5 at the end of the subscribe() is the priority.// The default priority of a subscribe() is 10. Lower is// higher priority.chilipeppr.subscribe('/com-chilipeppr-widget-serialport/jsonSend', this, this.onJsonSend, 5);// store macro in window object so we have it next time thruwindow["myMacro"] = this;<br><br>// get 3d coordinates by asking the 3d viewer to give them to us // we'll get this.obj3d set for us so we can use it laterthis.getXyzCoords();},uninit: function() {macro.status("Uninitting macro.");chilipeppr.unsubscribe("/com-chilipeppr-widget-serialport/jsonSend", this.onJsonSend);},onJsonSend: function(data) {console.group('pulley rewrite'); console.log(data);<br><br>// if the data is an array, then return immediately because we only want to do a rewrite// when jsonSend is individual lines, not when its a multiline array object.// this might seem odd why, but chilipeppr sends lines individually at first and does// it's own ganging up if user picked "multi-line" mode, so let's not rewrite stuff// over and over. just know that if you look for a single line you're safe.if (Array.isArray(data)) {console.log("data was an array, so returning immediately cuz don't want to modify arrays of jsonData");console.groupEnd();return;}<br><br>// extract the line from the ID which is of the form "g45" for line 45var line = parseInt(data.Id.replace(/g/, ""));<br><br>// get xyz coords and cleaned up meta data for gcode from the 3d viewer parsed datavar coord = this.getXyzCoordsForLine(line);console.log("xyz coords for line:", line, coord);<br><br>// check if we have a cmd and if it is a G0 or G1, otherwise returnif ('cmd' in coord.meta.args && coord.meta.args.cmd.match(/g1|g0/i)) {console.log("this is a command we want to process. good.");} else {console.log("This gcode line did not contain a G0 or G1 command, so not rewriting");console.groupEnd();return;}<br><br>var cmd = coord.meta.args.cmd;<br><br>// get simple vars for xyzvar x = coord.end.x;var y = coord.end.y;var z = coord.end.z;<br><br>//var x = 6;//var y = 2;//var z = 3;<br><br>// what are the positions of each corner for the pulleys so we can calcvar fl_pos = {x:0,y:0,z:10};var bl_pos = {x:0,y:10,z:10};var br_pos = {x:10,y:10,z:10};var fr_pos = {x:10,y:0,z:10};<br><br>// convert XYZ cartesion coordinates to XYZA (fl,bl,br,fr) pulley lengths// fl=front left, bl=back left, br=back right, fr=front right// Find hypotenuse length for fl,bl,br,fr in xy planevar fl_xy_hyp = Math.sqrt((x * x) + (y * y));var bl_xy_hyp = Math.sqrt((x * x) + ((bl_pos.y - y) * (bl_pos.y - y)));var br_xy_hyp = Math.sqrt(((br_pos.x - x) * (br_pos.x - x)) + ((br_pos.y - y) * (br_pos.y - y)));var fr_xy_hyp = Math.sqrt(((fr_pos.x - x) * (fr_pos.x - x)) + (Math.abs(fr_pos.y - y) * Math.abs(fr_pos.y - y)));<br><br>// Find hypotenuse length for z plane var fl_hyp = Math.sqrt((fl_xy_hyp * fl_xy_hyp) + ((fl_pos.z - z) * (fl_pos.z - z)));var bl_hyp = Math.sqrt((bl_xy_hyp * bl_xy_hyp) + ((bl_pos.z - z) * (bl_pos.z - z)));var br_hyp = Math.sqrt((br_xy_hyp * br_xy_hyp) + ((br_pos.z - z) * (br_pos.z - z)));var fr_hyp = Math.sqrt((fr_xy_hyp * fr_xy_hyp) + ((fr_pos.z - z) * (fr_pos.z - z)));<br><br>console.log("Pulley len FL:", fl_hyp, "len BL:", bl_hyp, "len BR:", br_hyp, "len FR:", fr_hyp);<br><br>var gcode = cmd + " X" + fl_hyp + " Y" + bl_hyp + " Z" + br_hyp + " A" + fr_hyp;console.log("Final gcode:", gcode);<br><br>// see if there was a feedrateif ('f' in coord.meta.args) {console.log("there was a feedrate:", coord.meta.args.f);gcode += " F" + coord.meta.args.f;}gcode += "\n";<br><br>//republish the gcode command that was interceptedvar obj = {D: gcode, Id: data.Id};// unsubscribe so that we don't get our own rewritten gcode coming back to uschilipeppr.unsubscribe('/com-chilipeppr-widget-serialport/jsonSend', this.onJsonSend); // send the gcode off as if nothing really changed, even tho we completely rewrote itchilipeppr.publish('/com-chilipeppr-widget-serialport/jsonSend', obj);// resubscribe immediately so we can rewrite the next line of gcodechilipeppr.subscribe('/com-chilipeppr-widget-serialport/jsonSend', this, this.onJsonSend, 5);<br><br>console.groupEnd();return false;},obj3d: null,getXyzCoords: function() {chilipeppr.subscribe("/com-chilipeppr-widget-3dviewer/recv3dObject", this, this.getXyzCoordsRecv3dObj);chilipeppr.publish("/com-chilipeppr-widget-3dviewer/request3dObject", "");},getXyzCoordsRecv3dObj: function(obj3d) {console.log("Got our 3d obj. Line count:", obj3d.userData.lines.length);this.obj3d = obj3d;// unsub so we don't get anymore callbacks on thischilipeppr.unsubscribe("/com-chilipeppr-widget-3dviewer/recv3dObject", this.getXyzCoordsRecv3dObj);},getXyzCoordsForLine: function(line) {console.log("getXyzCoordsForLine. line:", line);var ret = { start: {index: null, x: null, y: null, z: null},end: {index: null, x: null, y: null, z: null},meta: null};var indx = line - 2;if (indx < 0) indx = 0;ret.start.index = indx;ret.start.x = this.obj3d.userData.lines[indx].p2.x;ret.start.y = this.obj3d.userData.lines[indx].p2.y;ret.start.z = this.obj3d.userData.lines[indx].p2.z;indx = line - 1;ret.end.index = indx;ret.end.x = this.obj3d.userData.lines[indx].p2.x;ret.end.y = this.obj3d.userData.lines[indx].p2.y;ret.end.z = this.obj3d.userData.lines[indx].p2.z;ret.meta = this.obj3d.userData.lines[indx];return ret;}}myMacro.init();},watchOnCompleteControlArduino: function() {// Watch onComplete and Fire Laservar myMacro = {gcode: null, // holds our gcodearduinoSerialPort: "COM37", // we send laser cmds to Arduinoinit: function() {// Uninit previous runs to unsubscribe correctly, i.e.// so we don't subscribe 100's of times each time we modify// and run this macroif (window["myMacro"]) {macro.status("This macro was run before. Cleaning up...");window["myMacro"].uninit();}macro.status("Starting watch onComplete macro");// subscribe to onCompletechilipeppr.subscribe("/com-chilipeppr-widget-serialport/onComplete", this, this.onComplete);// store macro in window object so we have it next time thruwindow["myMacro"] = this;this.getGcode();},uninit: function() {macro.status("Uninitting macro.");chilipeppr.unsubscribe("/com-chilipeppr-widget-serialport/onComplete", this.onComplete);},getGcode: function() {chilipeppr.subscribe("/com-chilipeppr-widget-gcode/recvGcode", this, this.getGcodeCallback);chilipeppr.publish("/com-chilipeppr-widget-gcode/requestGcode", "");chilipeppr.unsubscribe("/com-chilipeppr-widget-gcode/recvGcode", this.getGcodeCallback);},getGcodeCallback: function(data) {this.gcode = data;},onComplete: function(data) {// macro.status("Got onCompleted. data:" + JSON.stringify(data));// Id's from the Gcode widget always start with g// If you jog, use the serial port console, or do other stuff we'll // see callbacks too, but we only want real gcode data hereif (data.Id.match(/^g(\d+)/)) {// $1 is populated with digits from the .match regex abovevar index = parseInt(RegExp.$1); // our id is always 1 ahead of the gcode.lines array index, i.e.// line 1 in the widget is this.gcode.lines[0]var gcodeline = this.gcode.lines[index - 1];<br><br>// Try to match M3, M5, and M30 (program end)// The \b is a word boundary so looking for M3 doesn't also// hit on M30if (gcodeline.match(/\bM3\b/i)) {// turn laser offmacro.status("Laser Off from line " + data.Id);chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "send " + this.arduinoSerialPort + " laser-off\n");} else if (gcodeline.match(/\bM5\b/i)) {// turn laser onmacro.status("Laser On from line " + data.Id);chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "send " + this.arduinoSerialPort + " laser-on\n");} else if (gcodeline.match(/\bM30\b/i)) {macro.status("Done running our gcode. Laser off.");chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "send " + this.arduinoSerialPort + " laser-off\n");this.uninit();}<br><br>}}}myMacro.init();},iterateGcode: function() {var gcodeIterator = {user3dObject: null, // stores 3d obj which also has gcodeinit: function() {this.get3dObjectFrom3dViewer();this.loopThruGcode();},recv3dObject: function(obj) {console.log("just got the user object:");this.user3dObject = obj;},get3dObjectFrom3dViewer: function() {// query the 3d viewer for it's core objectchilipeppr.subscribe("/com-chilipeppr-widget-3dviewer/recv3dObject", this, this.recv3dObject);chilipeppr.publish("/com-chilipeppr-widget-3dviewer/request3dObject", "");chilipeppr.unsubscribe("/com-chilipeppr-widget-3dviewer/recv3dObject", this, this.recv3dObject);},loopThruGcode: function() {var ctr = 0;this.user3dObject.userData.lines.forEach(function(item) {                        //console.log("line of gcode:", item);if (item.args.cmd == "G0") ctr++;});macro.status("You have " + ctr + " G0's in your Gcode");}};gcodeIterator.init();<br><br>},injectCams: function() {// Inject cams v1.2// You must be running your MultiCam // server from// http://jsfiddle.net/chilipeppr/stpbm/// You can run the server from any number // of computers to gang up tons of // cameras. This client below will pull // in all cameras being served and inject // them in a new right columnvar cams = {init: function() {$('#com-chilipeppr-ws-gcode-hdr').parent().addClass('nopadding');$('#com-chilipeppr-webrtcclient').remove();$('.pnlWorkspaceRtSidebarCollapsed').removeClass('col-xs-12').addClass('col-xs-10');$('#pnlRtSidebar').addClass('col-xs-2 nopadding').css('padding-right', '10px');// $('#pnlRtSidebar').html("");chilipeppr.load('#pnlRtSidebar', 'http://jsfiddle.net/chilipeppr/k9aXL/show/light', function() {macro.status("Cam fiddle loaded.");});},initCams: function() {macro.status("initting cams");cprequire(["inline:com-chilipeppr-widget-webrtc-clientmulti"], function (camlist) {console.log("running of " + camlist.id);camlist.init();});}}cams.init();cams.initCams();},downloadGcode: function() {// Opens new window and downloads Gcode to // local file. Shows use of cprequire() // which is the way to get access to any // of ChiliPeppr's modules. You can // override methods in a module, call // methods directly, or access properties // of that module.cprequire(['inline:com-chilipeppr-widget-gcode'], function(gcode) {var txt = gcode.fileLines.join('\n');window.open('data:text/csv;charset=utf-8,' + escape(txt));});},sendToArduino: function() {// Send a command to an Arduino on an alternate serial port// while connected to your CNC machine on the main serial port.<br><br>// Keep in mind the "green" colored serial port is the default// serial port for your CNC controller. You must be connected// to your Arduino on an alternate serial port with a checkbox// marked in the Serial Port Widget to show you're connected// but it must not be "green" to ensure it's not the default<br><br>var mymacro = {portArduino: "COM18",init: function() {macro.status("Initted my macro");// Subscribe to receive data events for all com ports// We will filter for our serial port datachilipeppr.subscribe("/com-chilipeppr-widget-serialport/ws/recv", this, this.onRecvData);// Subscribe to incoming position data from CNC controllerchilipeppr.subscribe("/com-chilipeppr-interface-cnccontroller/axes", this, this.onRecvPosition);},uninit: function() {macro.status("Uninitted my macro");chilipeppr.unsubscribe("/com-chilipeppr-widget-serialport/ws/recv", this.onRecvData);chilipeppr.unsubscribe("/com-chilipeppr-interface-cnccontroller/axes", this.onRecvPosition);},msg: "", // stores data receivedonRecvData: function(data) {// data comes in as it arrives, so not as lines// wait until we see a newline<br><br>// see if jsonif (data.match(/^{/)) {var json = $.parseJSON(data);if ('P' in json && json.P == this.portArduino) {console.log("got onRecvData for this port. json:", json);this.msg += json.D;if (this.msg.match(/\n/)) {macro.status(this.msg);this.msg = ""; // clear buffer}}}},onRecvPosition: function(pos) {// we get a nice object of XYZ valuesif (pos.x == 0 && pos.x == 0) {macro.status("Got 0,0 position so turn laser off");// Send command to Arduino, i.e. to tell it to turn laser offchilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "send " + this.portArduino + " laser-off\n");macro.status("Laser Off");mymacro.uninit();}},go: function() {<br><br>// Send command to Arduino, i.e. to tell it to turn laser on// Notice you must specify a port in this "/ws/send" since this// serial port is not the defaultchilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "send " + this.portArduino + " laser-on\n");macro.status("Laser On");<br><br>// Send command to CNCchilipeppr.publish("/com-chilipeppr-widget-serialport/send", "G0 X0 Y0\n");chilipeppr.publish("/com-chilipeppr-widget-serialport/send", "G0 X1 Y1\n");chilipeppr.publish("/com-chilipeppr-widget-serialport/send", "G0 X0 Y0\n");<br><br>}}mymacro.init();mymacro.go();<br><br>},cmdsSentViaTimeout: function() {// Loop the CNC machinechilipeppr.publish("/com-chilipeppr-widget-serialport/send", "G90\n"); // abs modechilipeppr.publish("/com-chilipeppr-widget-serialport/send", "G0 X0 Y0\n"); // 0,0var timeout = 1000;var cmds = [];var ctr = 0;for(var x = 0; x < 10; x++) {for(var y = 0; y < 10; y++) {cmds.push("G1 X" + x + " Y" + y + " F100\n");setTimeout(function() {var cmd = cmds[ctr];chilipeppr.publish("/com-chilipeppr-widget-serialport/send", cmd);macro.status("Sent " + cmd);ctr++;}, timeout);timeout = timeout + 1000;}}},addbbox: function() {var add = function() {chilipeppr.subscribe("/com-chilipeppr-widget-3dviewer/recv3dObject", function(obj) {console.log("3d obj:", obj);window["bbox"] = new THREE.BoundingBoxHelper(obj, 0xff0000)window["bbox"].update();// Create visible bounding boxchilipeppr.publish("/com-chilipeppr-widget-3dviewer/sceneadd", window["bbox"]);macro.status("added bounding box");});chilipeppr.publish("/com-chilipeppr-widget-3dviewer/request3dObject", "");};var remove = function() {console.log(window["bbox"]);chilipeppr.publish("/com-chilipeppr-widget-3dviewer/sceneremove", window["bbox"]);macro.status("removed bounding box");};// don't run add twice or it will rewrite a new bbox and you'll// never be able to remove itadd(); // comment this out and uncomment remove();//remove();},fadeout: function() {chilipeppr.subscribe("/com-chilipeppr-widget-3dviewer/recv3dObject", function(threed) {console.log("3d obj:", threed);threed.children[0].material.opacity = 0.99;chilipeppr.publish("/com-chilipeppr-widget-3dviewer/wakeanimate");macro.status("Faded out 3d object");});chilipeppr.publish("/com-chilipeppr-widget-3dviewer/request3dObject", "");<br><br>},sendGcodeToWorkspace: function() {var gcodetxt = "(This is my gcode)\nG92\nG0 Z1\nG1 X10\nY10\nX0\nY0\n";var info = {name: "My gcode file", lastModified: new Date()};// send event off as if the file was drag/droppedchilipeppr.publish("/com-chilipeppr-elem-dragdrop/ondropped", gcodetxt, info);},runTestProbe: function() {macro.status("Runing test probe.");chilipeppr.publish("/com-chilipeppr-widget-serialport/send", "G21 G90 (Use mm and abs coords)\n");chilipeppr.publish("/com-chilipeppr-widget-serialport/send", "G38.2 Z-10 F5\n");},watch: function() {// Send a Gcode command and then // watch the serial response// to trigger something nextvar that = this;var callback = function(data) {macro.status("data:" + data.dataline);<br><br>var json = $.parseJSON(data.dataline);<br><br>if ('sr' in json && ('posz' in json.sr || 'mpoz' in json.sr)) {<br><br>var zpos = null;if ('posz' in json.sr) zpos = json.sr.posz;else zpos = json.sr.mpoz;<br><br>zpos = parseFloat(zpos);if (zpos == 3) {// we hit the Z location we wanted.chilipeppr.unsubscribe("/com-chilipeppr-widget-serialport/recvline", that, callback);<br><br>alert("got to location we wanted");macro.status("got to z loc of 3.00");}}<br><br>};<br><br>// now subscribe and then usubscribe // so we don't get all responses// after the data we want.chilipeppr.subscribe("/com-chilipeppr-widget-serialport/recvline", this, callback);<br><br>// Send Gcode.macro.sendSerial("G0 Z4\n");macro.sendSerial("G0 Z3\n");<br><br>macro.status("Just sent Gcode cmd. Watching for response...");},sendSerial: function(gcode) {// send our datachilipeppr.publish("/com-chilipeppr-widget-serialport/send", gcode);},/* END SAMPLES |
| status | function | function (txt)  |
| getZMinSettings | function | function (donecallback)  |
| threeDGetUserObject | function | function ()  |
| threeDMakeText | function | function (vals)  |
| forkSetup | function | function ()  |


## About ChiliPeppr

[ChiliPeppr](http://chilipeppr.com) is a hardware fiddle, meaning it is a 
website that lets you easily
create a workspace to fiddle with your hardware from software. ChiliPeppr provides
a [Serial Port JSON Server](https://github.com/johnlauer/serial-port-json-server) 
that you run locally on your computer, or remotely on another computer, to connect to 
the serial port of your hardware like an Arduino or other microcontroller.

You then create a workspace at ChiliPeppr.com that connects to your hardware 
by starting from scratch or forking somebody else's
workspace that is close to what you are after. Then you write widgets in
Javascript that interact with your hardware by forking the base template 
widget or forking another widget that
is similar to what you are trying to build.

ChiliPeppr is massively capable such that the workspaces for 
[TinyG](http://chilipeppr.com/tinyg) and [Grbl](http://chilipeppr.com/grbl) CNC 
controllers have become full-fledged CNC machine management software used by
tens of thousands.

ChiliPeppr has inspired many people in the hardware/software world to use the
browser and Javascript as the foundation for interacting with hardware. The
Arduino team in Italy caught wind of ChiliPeppr and now
ChiliPeppr's Serial Port JSON Server is the basis for the 
[Arduino's new web IDE](https://create.arduino.cc/). If the Arduino team is excited about building on top
of ChiliPeppr, what
will you build on top of it?



